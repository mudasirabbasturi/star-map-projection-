<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>SVG Paper Sizes A0‚ÄìA4 ‚Äî Zoom, Pan, Vertical Text Drag</title>
    <style>
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: sans-serif;
        }

        #controls {
            margin: 10px;
        }

        select,
        button {
            padding: 6px 12px;
            margin: 0 5px;
            font-size: 14px;
            border: none;
            border-radius: 6px;
        }

        button {
            background: #333;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background: #555;
        }

        #zoomLevel {
            font-weight: bold;
            margin-left: 10px;
        }

        svg {
            border: 1px solid #ccc;
            background: white;
            width: 80%;
            height: auto;
            touch-action: none;
            /* let pointer events manage gestures */
        }

        svg.dragging {
            cursor: grabbing;
        }

        .text-draggable {
            cursor: ns-resize;
            user-select: none;
            -webkit-user-select: none;
        }
    </style>
</head>

<body>
    <div id="controls">
        <label for="paperSize">üìÑ Paper:</label>
        <select id="paperSize" onchange="setPaperSize(this.value)">
            <option value="A0">A0</option>
            <option value="A1">A1</option>
            <option value="A2">A2</option>
            <option value="A3">A3</option>
            <option value="A4" selected>A4</option>
        </select>

        <button onclick="toggleOrientation()">üìê Toggle Orientation</button>
        <button onclick="zoomIn()">‚ûï Zoom In</button>
        <button onclick="zoomOut()">‚ûñ Zoom Out</button>
        <button onclick="resetView()">üîÑ Reset</button>
        <span id="zoomLevel">100%</span>

        <button onclick="downloadSVG()">‚¨áÔ∏è SVG</button>
        <button onclick="downloadPNG()">‚¨áÔ∏è PNG</button>
    </div>

    <svg id="paperSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 796.8 1123.2">
        <g id="viewport" transform="translate(0,0)">
            <g id="content" transform="scale(1)">
                <rect id="paperRect" x="0" y="0" width="796.8" height="1123.2" fill="white" stroke="black" />
                <circle id="centerMark" cx="398.4" cy="561.6" r="8" fill="red" />

                <!-- 4 text fields (x set numerically by setPaperSize) -->
                <text id="addressText" class="text-draggable" x="398.4" y="100" font-size="28"
                    text-anchor="middle">Address</text>
                <text id="dateText" class="text-draggable" x="398.4" y="150" font-size="24"
                    text-anchor="middle">Date</text>
                <text id="messageText" class="text-draggable" x="398.4" y="561.6" font-size="32"
                    text-anchor="middle">Message</text>
                <text id="footerText" class="text-draggable" x="398.4" y="1050" font-size="20"
                    text-anchor="middle">Footer Note</text>
            </g>
        </g>
    </svg>

    <script>
        // ISO A sizes in px at 96 DPI
        const paperSizes = {
            A0: { w: 3177.6, h: 4492.8 },
            A1: { w: 2246.4, h: 3177.6 },
            A2: { w: 1584, h: 2246.4 },
            A3: { w: 1123.2, h: 1584 },
            A4: { w: 796.8, h: 1123.2 }
        };

        // State
        let scale = 1;
        let panX = 0, panY = 0;
        let currentSize = "A4";
        let isLandscape = false;

        // Elements
        const svgEl = document.getElementById("paperSvg");
        const viewport = document.getElementById("viewport");
        const content = document.getElementById("content");
        const rect = document.getElementById("paperRect");
        const center = document.getElementById("centerMark");
        const zoomLevel = document.getElementById("zoomLevel");

        const addressText = document.getElementById("addressText");
        const dateText = document.getElementById("dateText");
        const messageText = document.getElementById("messageText");
        const footerText = document.getElementById("footerText");

        // Utility: convert screen/client point -> SVG root coords
        function clientToSvgRoot(clientX, clientY) {
            const pt = svgEl.createSVGPoint();
            pt.x = clientX; pt.y = clientY;
            return pt.matrixTransform(svgEl.getScreenCTM().inverse());
        }
        // Utility: convert screen/client point -> content-local coords
        function clientToContentLocal(clientX, clientY) {
            const pt = svgEl.createSVGPoint();
            pt.x = clientX; pt.y = clientY;
            // content.getScreenCTM maps content-local -> screen; inverse does screen->content-local
            return pt.matrixTransform(content.getScreenCTM().inverse());
        }

        function updateZoomDisplay() {
            zoomLevel.textContent = Math.round(scale * 100) + "%";
        }

        function applyTransform() {
            viewport.setAttribute("transform", `translate(${panX},${panY})`);
            content.setAttribute("transform", `scale(${scale})`);
            updateZoomDisplay();
        }

        // Zoom controls
        function zoomIn() { scale *= 1.2; applyTransform(); }
        function zoomOut() { scale = Math.max(1, scale / 1.2); if (scale === 1) { panX = 0; panY = 0; } applyTransform(); }
        function resetView() { scale = 1; panX = 0; panY = 0; applyTransform(); }

        // Paper size & orientation
        function setPaperSize(size) {
            currentSize = size;
            const { w, h } = paperSizes[size];
            const width = isLandscape ? h : w;
            const height = isLandscape ? w : h;

            svgEl.setAttribute("viewBox", `0 0 ${width} ${height}`);
            rect.setAttribute("width", width);
            rect.setAttribute("height", height);
            center.setAttribute("cx", width / 2);
            center.setAttribute("cy", height / 2);

            // position text numerically (not %), so vertical drag works easily
            addressText.setAttribute("x", width / 2);
            addressText.setAttribute("y", Math.round(height * 0.06));    // near top
            dateText.setAttribute("x", width / 2);
            dateText.setAttribute("y", Math.round(height * 0.11));
            messageText.setAttribute("x", width / 2);
            messageText.setAttribute("y", Math.round(height * 0.5));     // center
            footerText.setAttribute("x", width / 2);
            footerText.setAttribute("y", Math.round(height * 0.95));     // near bottom

            // reset transforms so editor view shows freshly
            resetView();
        }

        function toggleOrientation() {
            isLandscape = !isLandscape;
            setPaperSize(currentSize);
        }

        // --- Pointer-based panning & vertical-only text dragging ---
        let isPanning = false;
        let panStart = null; // {x, y} in svg root coords
        let panStartXY = { x: 0, y: 0 };

        let isDraggingText = false;
        let draggedTextEl = null;
        let textDragStart = null; // point in content-local coords
        let textOrigY = 0;

        // Pointer down on svg
        svgEl.addEventListener('pointerdown', (e) => {
            // If pointer started on a text element -> start text-drag (vertical only)
            const targetText = e.target.closest('text');
            if (targetText && targetText.classList.contains('text-draggable')) {
                isDraggingText = true;
                draggedTextEl = targetText;
                svgEl.setPointerCapture(e.pointerId);

                // Map pointer to content-local coordinates (so movement ignores viewport translate/scale)
                const pt = clientToContentLocal(e.clientX, e.clientY);
                textDragStart = { x: pt.x, y: pt.y };
                textOrigY = parseFloat(draggedTextEl.getAttribute('y')) || 0;

                // add visual cue
                draggedTextEl.classList.add('dragging-text');
                return;
            }

            // Otherwise, start panning only if zoom > 100%
            if (scale > 1) {
                isPanning = true;
                svgEl.setPointerCapture(e.pointerId);
                panStart = clientToSvgRoot(e.clientX, e.clientY);
                panStartXY = { x: panX, y: panY };
                svgEl.classList.add('dragging');
            }
        });

        svgEl.addEventListener('pointermove', (e) => {
            if (isDraggingText && draggedTextEl) {
                // Compute pointer pos in content-local coordinates and move text vertically only
                const pt = clientToContentLocal(e.clientX, e.clientY);
                const dy = pt.y - textDragStart.y;
                const newY = textOrigY + dy;
                draggedTextEl.setAttribute('y', newY);
                return;
            }

            if (isPanning && panStart) {
                const pt = clientToSvgRoot(e.clientX, e.clientY);
                const dx = pt.x - panStart.x;
                const dy = pt.y - panStart.y;
                panX = panStartXY.x + dx;
                panY = panStartXY.y + dy;
                applyTransform();
            }
        });

        svgEl.addEventListener('pointerup', (e) => {
            if (isDraggingText) {
                isDraggingText = false;
                if (draggedTextEl) {
                    draggedTextEl.classList.remove('dragging-text');
                    draggedTextEl = null;
                }
                try { svgEl.releasePointerCapture(e.pointerId); } catch (err) { }
            }
            if (isPanning) {
                isPanning = false;
                panStart = null;
                svgEl.classList.remove('dragging');
                try { svgEl.releasePointerCapture(e.pointerId); } catch (err) { }
            }
        });

        // If pointer cancelled (touch cancelled)
        svgEl.addEventListener('pointercancel', (e) => {
            // cleanup
            if (isDraggingText) { isDraggingText = false; if (draggedTextEl) draggedTextEl.classList.remove('dragging-text'); draggedTextEl = null; }
            if (isPanning) { isPanning = false; panStart = null; svgEl.classList.remove('dragging'); }
        });

        // Prevent default touch gestures that can conflict
        svgEl.addEventListener('touchstart', (e) => { /* handled by pointer events */ }, { passive: false });

        // --- Downloads (reset view before exporting so zoom/pan don't affect saved file) ---
        function downloadSVG() {
            const { w, h } = paperSizes[currentSize];
            const width = isLandscape ? h : w;
            const height = isLandscape ? w : h;

            const clone = svgEl.cloneNode(true);
            // Reset viewport & content transform in clone
            const cloneViewport = clone.querySelector('#viewport');
            const cloneContent = clone.querySelector('#content');
            if (cloneViewport) cloneViewport.setAttribute('transform', 'translate(0,0)');
            if (cloneContent) cloneContent.setAttribute('transform', 'scale(1)');

            // Ensure viewBox is correct
            clone.setAttribute('viewBox', `0 0 ${width} ${height}`);

            const serializer = new XMLSerializer();
            const source = serializer.serializeToString(clone);
            const blob = new Blob([source], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentSize}_${isLandscape ? 'landscape' : 'portrait'}.svg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadPNG() {
            const { w, h } = paperSizes[currentSize];
            const width = isLandscape ? h : w;
            const height = isLandscape ? w : h;

            const clone = svgEl.cloneNode(true);
            const cloneViewport = clone.querySelector('#viewport');
            const cloneContent = clone.querySelector('#content');
            if (cloneViewport) cloneViewport.setAttribute('transform', 'translate(0,0)');
            if (cloneContent) cloneContent.setAttribute('transform', 'scale(1)');
            clone.setAttribute('viewBox', `0 0 ${width} ${height}`);

            const serializer = new XMLSerializer();
            const source = serializer.serializeToString(clone);
            const svg64 = btoa(unescape(encodeURIComponent(source)));
            const image64 = 'data:image/svg+xml;base64,' + svg64;
            const img = new Image();
            img.onload = function () {
                const canvas = document.createElement('canvas');
                canvas.width = Math.round(width);
                canvas.height = Math.round(height);
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                const png = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = png;
                a.download = `${currentSize}_${isLandscape ? 'landscape' : 'portrait'}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };
            img.src = image64;
        }

        // Initialize with default paper
        setPaperSize(currentSize);

        // Expose some functions to global scope (buttons)
        window.zoomIn = zoomIn;
        window.zoomOut = zoomOut;
        window.resetView = resetView;
        window.setPaperSize = setPaperSize;
        window.toggleOrientation = toggleOrientation;
        window.downloadSVG = downloadSVG;
        window.downloadPNG = downloadPNG;
    </script>
</body>

</html>
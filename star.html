<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Custom Celestial (Stars + Milky Way) — No D3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0b12;
      --panel: #141422;
      --text: #e6e6f0;
      --muted: #8e8ea3;
      --accent: #5dd0ff;
      --outline: #3a3a55;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      display: grid; grid-template-rows: auto 1fr; height: 100vh;
    }
    header {
      padding: 10px 14px; border-bottom: 1px solid var(--outline);
      display: grid; gap: 8px; grid-template-columns: 1fr; background: rgba(20,20,34,.6);
      backdrop-filter: blur(6px);
    }
    .controls {
      display: grid; gap: 8px;
      grid-template-columns: repeat(6, minmax(120px, auto));
      align-items: center;
    }
    .controls > div { background: var(--panel); border: 1px solid var(--outline); border-radius: 10px; padding: 8px 10px; }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
    input[type="range"] { width: 100%; }
    select, input[type="checkbox"] {
      accent-color: var(--accent);
    }
    .legend { font-size: 12px; color: var(--muted); display:flex; gap:16px; align-items:center; }
    .badge { padding: 4px 8px; border: 1px solid var(--outline); border-radius: 999px; background:#0f0f1a; }
    main { display:flex; justify-content:center; align-items:center; padding: 10px; }
    svg {
      width: min(92vw, 900px);
      height: auto;
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.45), inset 0 0 0 1px #22223a;
      background: radial-gradient(ellipse at center, #06060c, #000006 65%, #000 100%);
    }
    .outline { fill: none; stroke: #3a3a55; stroke-width: 1.25; stroke-dasharray: 4 4; }
    .star { fill: white; pointer-events: none; }
    .mw { fill: rgba(255,255,255,0.08); stroke: none; pointer-events: none; }
    .hidden { display:none; }
    .hint { font-size: 12px; color: var(--muted); text-align: center; padding: 6px 0 0; }
    .link { color: var(--accent); text-decoration: none; border-bottom:1px dashed var(--accent) }
  </style>
</head>
<body>
  <header>
    <div class="controls">
      <div>
        <label>Shape</label>
        <select id="shape">
          <option value="circle" selected>Circle</option>
          <option value="triangle">Triangle</option>
          <option value="heart">Heart</option>
          <option value="rect">Rectangle</option>
        </select>
      </div>
      <div>
        <label>Center RA (°)</label>
        <input id="centerRA" type="range" min="-180" max="180" step="1" value="0" />
      </div>
      <div>
        <label>Magnitude limit (fainter ←→ brighter)</label>
        <input id="magLimit" type="range" min="-1" max="6" step="0.1" value="5.5" />
      </div>
      <div>
        <label>Milky Way opacity</label>
        <input id="mwOpacity" type="range" min="0" max="0.35" step="0.01" value="0.12" />
      </div>
      <div>
        <label>Layers</label>
        <div style="display:flex; gap:12px; align-items:center;">
          <label style="margin:0; display:flex; gap:6px; align-items:center;">
            <input id="showStars" type="checkbox" checked /> Stars
          </label>
          <label style="margin:0; display:flex; gap:6px; align-items:center;">
            <input id="showMW" type="checkbox" checked /> Milky Way
          </label>
          <label style="margin:0; display:flex; gap:6px; align-items:center;">
            <input id="invertRA" type="checkbox" /> Flip RA (east-to-left)
          </label>
        </div>
      </div>
      <div class="legend">
        <span class="badge">No D3</span>
        <span class="badge">SVG + GeoJSON</span>
        <span class="badge">Clipped to shape</span>
      </div>
    </div>
    <div class="hint">
      Data source: d3-celestial (Hipparcos stars, Milky Way outlines). Pan/zoom nahin; simple equirectangular mapping with RA center shift.
    </div>
  </header>

  <main>
    <svg id="sky" viewBox="0 0 1200 1200" aria-label="Celestial">
      <!-- clipPath for masking everything to the chosen shape -->
      <defs>
        <clipPath id="maskShape">
          <circle id="maskCircle" cx="600" cy="600" r="520" />
        </clipPath>
      </defs>

      <!-- Visual outline of the mask shape -->
      <g id="shapeOutline">
        <circle class="outline" cx="600" cy="600" r="520" />
      </g>

      <!-- Everything inside this group is clipped to the shape -->
      <g clip-path="url(#maskShape)">
        <g id="mwLayer"></g>
        <g id="starsLayer"></g>
      </g>
    </svg>
  </main>

  <script>
    // ---------- CONFIG ----------
    const W = 1200, H = 1200;
    const center = { x: W/2, y: H/2 };
    let centerRA = 0;      // degrees, -180..180 (center of map horizontally)
    let invert = false;    // flip X direction if true
    let magLimit = 5.5;    // max (faintest) magnitude to draw
    let mwOpacity = 0.12;

    // Data URLs (raw GitHub)
    const URL_STARS = 'https://raw.githubusercontent.com/ofrohn/d3-celestial/master/data/stars.6.json';
    const URL_MW    = 'https://raw.githubusercontent.com/ofrohn/d3-celestial/master/data/mw.json';

    // DOM
    const svg = document.getElementById('sky');
    const starsLayer = document.getElementById('starsLayer');
    const mwLayer = document.getElementById('mwLayer');
    const maskCircle = document.getElementById('maskCircle');
    const shapeOutline = document.getElementById('shapeOutline');

    // Controls
    const shapeSel = document.getElementById('shape');
    const centerRAInput = document.getElementById('centerRA');
    const magLimitInput = document.getElementById('magLimit');
    const mwOpacityInput = document.getElementById('mwOpacity');
    const showStarsChk = document.getElementById('showStars');
    const showMWChk = document.getElementById('showMW');
    const invertRACheck = document.getElementById('invertRA');

    // ---------- SHAPES (mask + outline) ----------
    function setMaskTo(element) {
      // replace existing mask content with the given element clone
      const cp = document.querySelector('#maskShape');
      cp.innerHTML = '';
      cp.appendChild(element.cloneNode(true));

      // outline
      shapeOutline.innerHTML = '';
      const outline = element.cloneNode(true);
      outline.setAttribute('class','outline');
      shapeOutline.appendChild(outline);
    }

    function shapeCircle() {
      const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('cx', center.x);
      c.setAttribute('cy', center.y);
      c.setAttribute('r', 520);
      return c;
    }

    function shapeRect() {
      const pad = 120;
      const r = document.createElementNS('http://www.w3.org/2000/svg','rect');
      r.setAttribute('x', pad);
      r.setAttribute('y', pad);
      r.setAttribute('width', W - pad*2);
      r.setAttribute('height', H - pad*2);
      r.setAttribute('rx', 40);
      r.setAttribute('ry', 40);
      return r;
    }

    function shapeTriangle() {
      const r = 540, cx = center.x, cy = center.y + 40;
      const p1 = `${cx},${cy - r}`;
      const p2 = `${cx - r * 0.866},${cy + r * 0.5}`;
      const p3 = `${cx + r * 0.866},${cy + r * 0.5}`;
      const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
      poly.setAttribute('points', `${p1} ${p2} ${p3}`);
      return poly;
    }

    function shapeHeart() {
      // nice symmetric heart path centered at (600,600)
      const cx = center.x, cy = center.y + 80;
      const s = 1.1; // scale
      const path = `
        M ${cx} ${cy + 420*s}
        C ${cx - 380*s} ${cy + 180*s}, ${cx - 540*s} ${cy - 120*s}, ${cx - 280*s} ${cy - 260*s}
        C ${cx - 120*s} ${cy - 340*s}, ${cx} ${cy - 220*s}, ${cx} ${cy - 120*s}
        C ${cx} ${cy - 220*s}, ${cx + 120*s} ${cy - 340*s}, ${cx + 280*s} ${cy - 260*s}
        C ${cx + 540*s} ${cy - 120*s}, ${cx + 380*s} ${cy + 180*s}, ${cx} ${cy + 420*s}
        Z`;
      const p = document.createElementNS('http://www.w3.org/2000/svg','path');
      p.setAttribute('d', path);
      return p;
    }

    function updateShape() {
      const v = shapeSel.value;
      if (v === 'circle') setMaskTo(shapeCircle());
      else if (v === 'rect') setMaskTo(shapeRect());
      else if (v === 'triangle') setMaskTo(shapeTriangle());
      else if (v === 'heart') setMaskTo(shapeHeart());
    }

    // ---------- PROJECTION (simple equirectangular with RA center) ----------
    // GeoJSON uses [lon, lat] where lon ~ RA in degrees (east-positive).
    // We apply a horizontal shift so that 'centerRA' is in the middle of the view.
    function wrapLon(lon) {
      while (lon <= -180) lon += 360;
      while (lon > 180) lon -= 360;
      return lon;
    }

    function raDecToXY(lon, lat) {
      // center shift: bring centerRA to x = W/2
      let shifted = wrapLon(lon - centerRA);
      // invert left/right if requested (astronomy charts often have east to the left)
      if (invert) shifted = -shifted;

      const x = ((shifted + 180) / 360) * W;
      const y = H - ((lat + 90) / 180) * H;
      return { x, y };
    }

    // ---------- STAR SIZE from magnitude ----------
    function starRadius(mag) {
      // brighter (lower mag) => bigger radius; clamp
      // rough scale: mag 0 => ~3.2 px, mag 6 => ~0.6 px
      const r = 3.2 - 0.45 * (mag);
      return Math.max(0.5, Math.min(3.5, r));
    }

    // ---------- RENDERERS ----------
    let starsData = null;
    let mwData = null;

    async function loadData() {
      const [starsRes, mwRes] = await Promise.all([
        fetch(URL_STARS), fetch(URL_MW)
      ]);
      starsData = await starsRes.json();
      mwData = await mwRes.json();
    }

    function renderStars() {
      starsLayer.innerHTML = '';
      if (!showStarsChk.checked || !starsData) return;

      const frag = document.createDocumentFragment();
      for (const f of starsData.features) {
        const mag = f.properties && typeof f.properties.mag === 'number'
          ? f.properties.mag : 6.5;
        if (mag > magLimit) continue;

        const [lon, lat] = f.geometry.coordinates; // [lon, lat]
        const { x, y } = raDecToXY(lon, lat);
        // quick cull: ignore way outside viewBox; mask will clip final
        if (x < -10 || x > W+10 || y < -10 || y > H+10) continue;

        const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
        c.setAttribute('class','star');
        c.setAttribute('cx', x.toFixed(2));
        c.setAttribute('cy', y.toFixed(2));
        c.setAttribute('r', starRadius(mag).toFixed(2));
        c.setAttribute('opacity', (0.95 - Math.max(0, (mag - 0))/10).toFixed(2));
        frag.appendChild(c);
      }
      starsLayer.appendChild(frag);
    }

    function renderMilkyWay() {
      mwLayer.innerHTML = '';
      if (!showMWChk.checked || !mwData) return;

      const frag = document.createDocumentFragment();
      const baseOpacity = parseFloat(mwOpacity.toString());

      // mw.json is MultiPolygon-like: features[].geometry.coordinates: [[[ring],[ring]...], ...]
      for (const feature of mwData.features) {
        const coords = feature.geometry.coordinates; // array of polygons; each polygon is array of rings
        for (const polygon of coords) {
          for (const ring of polygon) {
            let d = '';
            for (let i=0;i<ring.length;i++) {
              const [lon, lat] = ring[i];
              const { x, y } = raDecToXY(lon, lat);
              d += (i===0 ? `M${x},${y}` : `L${x},${y}`);
            }
            d += 'Z';

            const p = document.createElementNS('http://www.w3.org/2000/svg','path');
            p.setAttribute('class','mw');
            p.setAttribute('d', d);
            p.setAttribute('opacity', baseOpacity.toString());
            frag.appendChild(p);
          }
        }
      }
      mwLayer.appendChild(frag);
    }

    function renderAll() {
      renderMilkyWay();
      renderStars();
    }

    // ---------- EVENTS ----------
    shapeSel.addEventListener('change', () => { updateShape(); });
    centerRAInput.addEventListener('input', e => {
      centerRA = parseFloat(e.target.value);
      renderAll();
    });
    magLimitInput.addEventListener('input', e => {
      magLimit = parseFloat(e.target.value);
      renderStars();
    });
    mwOpacityInput.addEventListener('input', e => {
      mwOpacity = parseFloat(e.target.value);
      renderMilkyWay();
    });
    showStarsChk.addEventListener('change', renderAll);
    showMWChk.addEventListener('change', renderAll);
    invertRACheck.addEventListener('change', e => {
      invert = e.target.checked;
      renderAll();
    });

    // ---------- INIT ----------
    (async function init() {
      updateShape(); // default circle mask
      await loadData();
      renderAll();
    })();
  </script>
</body>
</html>
